<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>最新結果畫廊</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- Site icons -->
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}?v=1">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32.png') }}?v=1">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16.png') }}?v=1">
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}?v=1">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon.png') }}?v=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    .grid-gallery{display:grid;gap:16px;grid-template-columns:repeat(1,minmax(0,1fr))}
    @media (min-width:700px){.grid-gallery{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .thumb{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px}
    .thumb img{width:100%;border-radius:8px;display:block}
    .meta{font-size:12px;color:var(--muted);margin-top:6px}
    .stars{display:flex;gap:4px;margin-top:8px}
    .star{cursor:pointer;font-size:18px;color:#888}
    .star.active{color:#ffcc33}
    .avg{font-size:12px;color:var(--muted);margin-left:6px}
  </style>
  </head>
<body>
  <div class="container">
    {% include '_nav.html' %}
    <h1 class="title">最新結果畫廊</h1>
    <div class="grid-gallery">
      {% for im in images %}
        <div class="thumb" data-filename="{{ im.filename }}" data-image-id="{{ im.id }}">
          <a href="{{ url_for('main.serve_output', filename=im.filename) }}" target="_blank">
            <img src="{{ url_for('main.serve_output', filename=im.filename) }}" alt="{{ im.filename }}">
          </a>
          <div class="meta">{{ im.kind }} · {{ im.created_at }}</div>
          {% set cnt = im.ratings|length %}
          {% set avg = (im.ratings|map(attribute='rating')|list|sum / cnt) if cnt>0 else 0 %}
          <div class="stars" aria-label="rate" role="radiogroup">
            {% for i in range(1,6) %}
              <span class="star{% if i <= avg|round(0,'floor') %} active{% endif %}" data-value="{{ i }}">★</span>
            {% endfor %}
            <span class="avg">{{ '%.2f' % avg }} ({{ cnt }})</span>
          </div>
        </div>
      {% else %}
        <p>目前尚無作品。</p>
      {% endfor %}
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.thumb .stars').forEach(group => {
        const box = group.closest('.thumb');
        const imageId = box?.dataset.imageId; const filename = box?.dataset.filename;
        group.querySelectorAll('.star').forEach(star => {
          star.addEventListener('click', async () => {
            const val = parseInt(star.dataset.value || '0');
            try {
              const res = await fetch('/rate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ image_id: imageId, filename, rating: val }) });
              const j = await res.json();
              if (res.ok) {
                const floor = Math.floor(j.avg || val);
                group.querySelectorAll('.star').forEach((s, idx) => s.classList.toggle('active', idx < floor));
                const avgEl = group.querySelector('.avg'); if (avgEl) avgEl.textContent = (j.avg?.toFixed(2) || val.toFixed(2)) + ' (' + (j.count || 1) + ')';
              } else {
                alert(j.error || '評分失敗');
              }
            } catch (e) { alert('連線失敗'); }
          });
        });
      });
    });
  </script>
  {% include '_footer.html' %}
</body>
</html>

